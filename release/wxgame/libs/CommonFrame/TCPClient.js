tywx.TCPClient={TAG:"TCP client",CONNECT_STATUS_OK:1,CONNECT_STATUS_OPENING:2,CONNECT_STATUS_CLOSING:3,CONNECT_STATUS_FAIL:0,connectStatus:0,isTimerInited:!1,tickCount:0,filterCmds:"heartbeat",timerSchedule:function(){tywx.TCPClient.tickCount=(tywx.TCPClient.tickCount+1)%3,2==tywx.TCPClient.tickCount&&tywx.TCPClient.connectStatus==tywx.TCPClient.CONNECT_STATUS_OK&&tywx.NotificationCenter.trigger(tywx.EventType.SEND_HEART_BEAT),tywx.TCPClient.reconnet()},startCheckTimer:function(){tywx.TCPClient.isTimerInited=!0,tywx.Timer.setTimer(cc.director,this.timerSchedule,1)},stopCheckTimer:function(){tywx.TCPClient.isTimerInited=!1,tywx.Timer.cancelTimer(cc.director,this.timerSchedule)},connect:function(t){tywx.BiLog.clickStat(tywx.clickStatEventType.clickStatEventTypeTCPStart,[t]),tywx.TCPClient.connectStatus!=tywx.TCPClient.CONNECT_STATUS_OPENING&&tywx.TCPClient.connectStatus!=tywx.TCPClient.CONNECT_STATUS_OK&&(tywx.TCPClient.connectStatus=tywx.TCPClient.CONNECT_STATUS_OPENING,tywx.IsWechatPlatform()&&this.doWechatConnect(t))},doWechatConnect:function(t){try{if(!tywx.IsWechatPlatform())return;wx.connectSocket({url:t}),wx.onSocketOpen(function(e){tywx.LOGD(tywx.TCPClient.TAG,"TCP webSocket opened..."),tywx.TCPClient.connectStatus=tywx.TCPClient.CONNECT_STATUS_OK,tywx.NotificationCenter.trigger(tywx.EventType.TCP_OPENED),tywx.BiLog.clickStat(tywx.clickStatEventType.clickStatEventTypeTCPSuccess,[t])}),wx.onSocketError(function(e){tywx.LOGD(tywx.TCPClient.TAG,"TCP webSocket error..."),tywx.BiLog.clickStat(tywx.clickStatEventType.clickStatEventTypeTCPFailed,[t]),tywx.TCPClient.connectStatus=tywx.TCPClient.CONNECT_STATUS_FAIL,tywx.NotificationCenter.trigger(tywx.EventType.TCP_ERROR)}),wx.onSocketClose(function(t){tywx.LOGD(tywx.TCPClient.TAG,"WebSocket 已关闭！"),tywx.TCPClient.connectStatus=tywx.TCPClient.CONNECT_STATUS_FAIL,tywx.NotificationCenter.trigger(tywx.EventType.TCP_CLOSE)}),wx.onSocketMessage(function(t){if(tywx.StateInfo.isOnForeground){var e=tywx.TCPClient.decodeMessage(t.data);if(null!=e&&"0000"!=e){var n="[Receive TCP Msg]: "+unescape(e.replace(/\\u/gi,"%u")),i=e.substr(0,e.length-0);if(null!=i&&i.length>0){var C=JSON.parse(i);-1==tywx.TCPClient.filterCmds.indexOf(C.cmd)&&tywx.LOGD(tywx.TCPClient.TAG,n),tywx.NotificationCenter.trigger(tywx.EventType.TCP_RECEIVE,C)}}}})}catch(t){tywx.LOGE("error:","tywx.TCPClient.doWechatConnect——"+JSON.stringify(t))}},decodeMessage:function(t){if("undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer){for(var e=new Uint8Array(t),n="",i=0,C=e.length;i<C;i++){n+=String.fromCharCode(e[i])}return n}for(var c=(t=tywx.EncodeDecode.base64Decode(t)).slice(0,4),i=0,C=(t=t.slice(4)).length;i<C;i++){var T=t[i];T^=c[i%4],t[i]=T}return tywx.EncodeDecode.utf8Decode(t)},reconnet:function(){tywx.StateInfo.isOnForeground&&tywx.TCPClient.connectStatus==tywx.TCPClient.CONNECT_STATUS_FAIL&&(tywx.NotificationCenter.trigger(tywx.EventType.TCP_RECONNECT),tywx.TCPClient.connect(tywx.SystemInfo.webSocketUrl))},sendMsg:function(t){try{if(tywx.TCPClient.connectStatus!=tywx.TCPClient.CONNECT_STATUS_OK)return;var e=JSON.stringify(t);tywx.Util.isNullOrEmpty(t.params)||-1!=tywx.TCPClient.filterCmds.indexOf(t.params.action)||tywx.LOGD(tywx.TCPClient.TAG,"[Send TCP Msg]: "+e),tywx.IsWechatPlatform()&&wx.sendSocketMessage({data:e,success:function(t){},fail:function(t){var e=t[0];e&&"sendSocketMessage:fail taskID not exist"===e.errMsg&&(wx.closeSocket(),tywx.TCPClient.connectStatus=tywx.TCPClient.CONNECT_STATUS_FAIL),tywx.LOGD(tywx.TCPClient.TAG,"[Send TCP Msg fail]: "+JSON.stringify(arguments))},complete:function(t){}})}catch(t){tywx.LOGE("error:","tywx.TCPClient.sendMsg——"+JSON.stringify(t))}},close:function(){try{tywx.TCPClient.connectStatus=tywx.TCPClient.CONNECT_STATUS_CLOSING,tywx.IsWechatPlatform()&&wx.closeSocket(),tywx.LOGD(tywx.TCPClient.TAG,"TCP close..............")}catch(t){tywx.LOGE("error:","tywx.TCPClient.close——"+JSON.stringify(t))}}};