FZ.TCPClient={TAG:"TCP client",CONNECT_STATUS_OK:1,CONNECT_STATUS_OPENING:2,CONNECT_STATUS_CLOSING:3,CONNECT_STATUS_FAIL:0,connectStatus:0,isTimerInited:!1,tickCount:0,filterCmds:"heartbeat",timerSchedule:function(){FZ.TCPClient.tickCount=(FZ.TCPClient.tickCount+1)%3,2==FZ.TCPClient.tickCount&&FZ.TCPClient.connectStatus==FZ.TCPClient.CONNECT_STATUS_OK&&FZ.NotificationCenter.trigger(FZ.EventType.SEND_HEART_BEAT),FZ.TCPClient.reconnet()},startCheckTimer:function(){FZ.TCPClient.isTimerInited=!0,FZ.Timer.setTimer(cc.director,this.timerSchedule,1)},stopCheckTimer:function(){FZ.TCPClient.isTimerInited=!1,FZ.Timer.cancelTimer(cc.director,this.timerSchedule)},connect:function(t){FZ.BiLog.clickStat(FZ.clickStatEventType.clickStatEventTypeTCPStart,[t]),FZ.TCPClient.connectStatus!=FZ.TCPClient.CONNECT_STATUS_OPENING&&FZ.TCPClient.connectStatus!=FZ.TCPClient.CONNECT_STATUS_OK&&(FZ.TCPClient.connectStatus=FZ.TCPClient.CONNECT_STATUS_OPENING,FZ.IsWechatPlatform()&&this.doWechatConnect(t))},doWechatConnect:function(t){try{if(!FZ.IsWechatPlatform())return;wx.connectSocket({url:t}),wx.onSocketOpen(function(e){FZ.LOGD(FZ.TCPClient.TAG,"TCP webSocket opened..."),FZ.TCPClient.connectStatus=FZ.TCPClient.CONNECT_STATUS_OK,FZ.NotificationCenter.trigger(FZ.EventType.TCP_OPENED),FZ.BiLog.clickStat(FZ.clickStatEventType.clickStatEventTypeTCPSuccess,[t])}),wx.onSocketError(function(e){FZ.LOGD(FZ.TCPClient.TAG,"TCP webSocket error..."),FZ.BiLog.clickStat(FZ.clickStatEventType.clickStatEventTypeTCPFailed,[t]),FZ.TCPClient.connectStatus=FZ.TCPClient.CONNECT_STATUS_FAIL,FZ.NotificationCenter.trigger(FZ.EventType.TCP_ERROR)}),wx.onSocketClose(function(t){FZ.LOGD(FZ.TCPClient.TAG,"WebSocket 已关闭！"),FZ.TCPClient.connectStatus=FZ.TCPClient.CONNECT_STATUS_FAIL,FZ.NotificationCenter.trigger(FZ.EventType.TCP_CLOSE)}),wx.onSocketMessage(function(t){if(FZ.StateInfo.isOnForeground){var e=FZ.TCPClient.decodeMessage(t.data);if(null!=e&&"0000"!=e){var n="[Receive TCP Msg]: "+unescape(e.replace(/\\u/gi,"%u")),i=e.substr(0,e.length-0);if(null!=i&&i.length>0){var C=JSON.parse(i);-1==FZ.TCPClient.filterCmds.indexOf(C.cmd)&&FZ.LOGD(FZ.TCPClient.TAG,n),FZ.NotificationCenter.trigger(FZ.EventType.TCP_RECEIVE,C)}}}})}catch(t){FZ.LOGE("error:","FZ.TCPClient.doWechatConnect——"+JSON.stringify(t))}},decodeMessage:function(t){if("undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer){for(var e=new Uint8Array(t),n="",i=0,C=e.length;i<C;i++){n+=String.fromCharCode(e[i])}return n}for(var c=(t=FZ.EncodeDecode.base64Decode(t)).slice(0,4),i=0,C=(t=t.slice(4)).length;i<C;i++){var T=t[i];T^=c[i%4],t[i]=T}return FZ.EncodeDecode.utf8Decode(t)},reconnet:function(){FZ.StateInfo.isOnForeground&&FZ.TCPClient.connectStatus==FZ.TCPClient.CONNECT_STATUS_FAIL&&(FZ.NotificationCenter.trigger(FZ.EventType.TCP_RECONNECT),FZ.TCPClient.connect(FZ.SystemInfo.webSocketUrl))},sendMsg:function(t){try{if(FZ.TCPClient.connectStatus!=FZ.TCPClient.CONNECT_STATUS_OK)return;var e=JSON.stringify(t);FZ.Util.isNullOrEmpty(t.params)||-1!=FZ.TCPClient.filterCmds.indexOf(t.params.action)||FZ.LOGD(FZ.TCPClient.TAG,"[Send TCP Msg]: "+e),FZ.IsWechatPlatform()&&wx.sendSocketMessage({data:e,success:function(t){},fail:function(t){var e=t[0];e&&"sendSocketMessage:fail taskID not exist"===e.errMsg&&(wx.closeSocket(),FZ.TCPClient.connectStatus=FZ.TCPClient.CONNECT_STATUS_FAIL),FZ.LOGD(FZ.TCPClient.TAG,"[Send TCP Msg fail]: "+JSON.stringify(arguments))},complete:function(t){}})}catch(t){FZ.LOGE("error:","FZ.TCPClient.sendMsg——"+JSON.stringify(t))}},close:function(){try{FZ.TCPClient.connectStatus=FZ.TCPClient.CONNECT_STATUS_CLOSING,FZ.IsWechatPlatform()&&wx.closeSocket(),FZ.LOGD(FZ.TCPClient.TAG,"TCP close..............")}catch(t){FZ.LOGE("error:","FZ.TCPClient.close——"+JSON.stringify(t))}}};